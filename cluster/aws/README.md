# Provision k8s environment in AWS

These instructions provide configuration example of a k8s cluster using AWS infrastructure.

## scripted configuration

The fasted way to provision and configure the Kubernetes (k8s) cluster is to use scripts in this repository. The main script `provision-cluster.sh` provisions AWS ec2 instances ready for k8s installation. The script outputs several resources in the end:

- `*.pem` - contains the private key of AWS ec2 key pair generated for ec2 instances.
- `*-resources` - contains IDs of created resources for the cluster and public IPs of the instances.
- `*-cleanup.sh` - a cleanup script to remove all resources that `provision-cluster.sh` script created. Make sure to review this script before executing it to better understand what resources will be removed.
- `helper-prep-master-node.sh` - should be used on a `master` host to prepare k8s `master` node and download k8s binaries for Windows.
  >This was done to speed up Windows configuration process as direct download of k8s binaries to a Windows node was taking significantly more time.
- `helper-prep-win-node.ps1` - configures necessary features and a service on Windows host. Must be executed on a Windows node in `Powershell`.
- `helper-configure-calico.ps1` - configures and installs Calico and k8s components. Must be executed on a Windows node in `Powershell`.

Follow instructions in the next three sections to install and configure k8s cluster. Make sure to install Calico CNI before moving onto configuring Windows hosts. Once CNI is installed, the scripted approach can be used to configure Windows hosts. The flow for scripted installation is the following:

- upload `Calico for Windows` package (e.g. `tigera-calico-windows-v3.12.1.zip`) into the `$HOME` of `ubuntu` user on the `master` host
- copy `helper-prep-master-node.sh` script into `$HOME` directory of `ubuntu` user on the `master` host and execute it.
- copy private SSH key into `$HOME` directory on Windows host. Make sure to use the same file name as for the `*.pem` file generated by `provision-cluster.sh` script.
- copy `helper-prep-win-node.ps1` script into `$HOME\Downloads` path and execute it.
  >This will reboot the instance. If prompted, confirm the reboot action.
- copy `helper-configure-calico.ps1` script into `$HOME\Downloads` path and execute it.

Example using Linux `master` host to transfer files to Windows hosts.

```bash
MASTER0_IP='xx.xx.xx.xx' # set master node public IP
# upload files to master host
scp -i ./calico-aws-ec2.pem /tmp/tigera-calico-windows-v3.12.1.zip ./helper-prep-win-node.ps1 ./helper-configure-calico.ps1  ubuntu@$MASTER0_IP:~/
```

Download files onto Windows host from the `master` using `Powershell` shell on Windows side. This assumes that `*.pem` was transferred to the Windows host.

```powershell
MASTER0_IP='xx.xx.xx.xx' # set master node public IP
SSH_KEY='./path/to/ssh_key' # ssh private key
# download files on Windows
scp.exe -o StrictHostKeyChecking=no -i $SSH_KEY ubuntu@$MASTER0_IP`:~/tigera-calico-windows-v3.12.1.zip .\Downloads\
scp.exe -o StrictHostKeyChecking=no -i $SSH_KEY ubuntu@$MASTER0_IP`:~/helper-prep-win-node.ps1 .\Downloads\
scp.exe -o StrictHostKeyChecking=no -i $SSH_KEY ubuntu@$MASTER0_IP`:~/helper-configure-calico.ps1 .\Downloads\
```

## provision cluster infrastructure

```bash
git clone https://github.com/tigera-solutions/install-calico-for-windows.git
cd install-calico-for-windows/cluster/aws
chmod +x provision-cluster.sh
./provision-cluster.sh
```

## launch k8s cluster and join Linux workers

`SSH` into the master node and initialize k8s control plane. The `cluster/aws/cloud-config.yaml` contains example configuration for k8s cluster and can be used to launch the cluster.

```bash
MASTER0_IP='xx.xx.xx.xx' # set master node public IP in your local shell
SSH_KEY='./path/to/ssh_key'
cmhod 0600 $SSH_KEY
ssh -i $SSH_KEY -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no ubuntu@$MASTER0_IP
# commands below should be executed from the master node
MASTER0_IP=$(curl http://169.254.169.254/latest/meta-data/public-ipv4) # get master node public IP from ec2 metadata
# copy kubeadm example config
sudo cp /root/kubeadm/kubeadm-config.yaml ./
# export k8s control plane endpoint var
export MASTER_PUB_IP=$MASTER0_IP
sed -i "" 's/\#controlPlaneEndpoint:\ $MASTER_PUB_IP/controlPlaneEndpoint: $MASTER_PUB_IP/g' ./kubeadm-config.yaml
envsubst < kubeadm-config.yaml > cluster-config.yaml
# launch k8s cluster
sudo kubeadm init --config=cluster-config.yaml
# get certificate hash and join token to use with join command
CERT_HASH=$(openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //')
JOIN_TOKEN=$(kubeadm token list -o jsonpath='{.token}')
```

Once control plane is launched execute suggested commands from `kubeadm init` output.

```bash
# run suggested kubeadm commands
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
# list cluster nodes
kubectl get nodes
```

 Use `kubeadm join` command (i.e. without `--control-plane`) to join any Linux worker nodes to the cluster.

```bash
WORKER1_IP='xx.xx.xx.xx' # set linux worker node public IP
SSH_KEY='./path/to/ssh_key'
ssh -i $SSH_KEY -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no ubuntu@$WORKER1_IP
# commands below should be executed on each worker node
MASTER0_IP='xx.xx.xx.xx' # set master node public IP
# join Linux worker node
JOIN_TOKEN='xxxxx'
CERT_HASH='xxxxx' # use certificate hash value retrieved from master node
sudo kubeadm join ${MASTER0_IP}:6443 --token $JOIN_TOKEN --discovery-token-ca-cert-hash sha256:${CERT_HASH}
```

[Continue with Calico installation](../../README.md#install-and-configure-calico).
